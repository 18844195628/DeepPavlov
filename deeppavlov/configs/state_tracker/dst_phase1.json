{
  "dataset_reader": {
    "class_name": "sim_r_reader",
    "mode": "train_on_test",
    "data_path": "{DOWNLOADS_PATH}/google-dialogues"
  },
  "dataset_iterator": {
    "class_name": "dialog_state_iterator"
  },
  "chainer": {
    "in": [
      "u_utter", "u_slots_bio", "u_acts", "s_tokens", "s_slots_bio", "s_acts", "prev_state"
    ],
    "in_y": ["state"],
    "out": ["state_pred"],
    "pipe": [
      {
        "class_name": "deeppavlov.models.state_tracker.preprocessors:ActionVocabulary",
        "id": "user_action_vocab",
        "load_path": "{MODELS_PATH}/dst/user_actions.dict",
        "save_path": "{MODELS_PATH}/dst/user_actions.dict",
        "special_tokens": ["unknown"],
        "default_token": "unknown",
        "in": ["u_acts"],
        "out": ["u_act_idx"]
      },
      {
        "class_name": "deeppavlov.models.state_tracker.preprocessors:ActionVocabulary",
        "id": "system_action_vocab",
        "load_path": "{MODELS_PATH}/dst/system_actions.dict",
        "save_path": "{MODELS_PATH}/dst/system_actions.dict",
        "special_tokens": ["unknown"],
        "default_token": "unknown",
        "in": ["s_acts"],
        "out": ["s_act_idx"]
      },
      {
        "class_name": "simple_vocab",
        "id": "slot_vocab",
        "save_path": "{MODELS_PATH}/dst/slot_names_simr.dict",
        "fit_on": ["state"]
      },
      {
        "class_name": "lazy_tokenizer",
        "in": ["u_utter"],
        "out": ["u_tokens"]
      },
      {
        "class_name": "deeppavlov.models.state_tracker.preprocessors:Delexicalizor",
        "in": ["u_tokens", "u_slots_bio"],
        "out": ["u_norm_tokens"]
      },
      {
        "class_name": "deeppavlov.models.state_tracker.preprocessors:Delexicalizor",
        "in": ["s_tokens", "s_slots_bio"],
        "out": ["s_norm_tokens"]
      },
      {
        "class_name": "simple_vocab",
        "id": "word_vocab",
        "save_path": "{MODELS_PATH}/dst/word_simr.dict",
        "load_path": "{MODELS_PATH}/dst/word_simr.dict",
        "fit_on": ["u_norm_tokens", "s_norm_tokens"],
        "special_tokens": ["<unk>"],
        "in": ["u_norm_tokens"],
        "out": ["u_tok_idx"]
      },
      {
        "ref": "word_vocab",
        "in": ["s_norm_tokens"],
        "out": ["s_tok_idx"]
      },
      {
        "class_name": "emb_mat_assembler",
        "id": "embeddings",
        "embedder": {
          "class_name": "glove",
          "load_path": "{DOWNLOADS_PATH}/embeddings/glove.6B.100d.txt"
        },
        "vocab": "#word_vocab" 
      },
      {
        "class_name": "deeppavlov.models.state_tracker.preprocessors:SlotsBioMarkup2Dict",
        "in": ["u_tokens", "u_slots_bio"],
        "out": ["u_slots"]
      },
      {
        "class_name": "deeppavlov.models.state_tracker.preprocessors:SlotsBioMarkup2Dict",
        "in": ["s_tokens", "s_slots_bio"],
        "out": ["s_slots"]
      },
      {
        "class_name": "slot_value_filter",
        "id": "slot_filter",
        "max_num_values": 7,
        "exclude_values": ["dontcare"],
        "in": ["u_slots", "s_slots", "prev_state"],
        "out": ["slot_candidates"]
      },
      {
        "class_name": "deeppavlov.models.state_tracker.candidates:CandidateIndexerBuilder",
        "special_values": ["null", "dontcare"],
        "in": ["slot_candidates"],
        "out": ["slot_cand_indexer"]
      },
      {
        "class_name": "deeppavlov.models.state_tracker.candidates:SlotsValuesMatrixBuilder",
        "slot_vocab": "#slot_vocab",
        "max_num_values": "#slot_filter.max_num_values",
        "in": ["slot_cand_indexer"],
        "out": ["slot_cand_mask_matr"]
      },
      {
        "class_name": "deeppavlov.models.state_tracker.preprocessors:SlotsTokensMatrixBuilder",
        "slot_vocab": "#slot_vocab",
        "in": ["u_tokens", "u_slots_bio", "slot_cand_indexer"],
        "out": ["u_tok_slot_idx_matr"]
      },
      {
        "class_name": "deeppavlov.models.state_tracker.preprocessors:SlotsTokensMatrixBuilder",
        "slot_vocab": "#slot_vocab",
        "in": ["s_tokens", "s_slots_bio", "slot_cand_indexer"],
        "out": ["s_tok_slot_idx_matr"]
      },
      {
        "class_name": "deeppavlov.models.state_tracker.preprocessors:SlotsValuesMatrixBuilder",
        "slot_vocab": "#slot_vocab",
        "max_num_values": "#slot_filter.max_num_values",
        "in": ["state", "slot_cand_indexer"],
        "out": ["state_matr"]
      },
      {
        "class_name": "deeppavlov.models.state_tracker.preprocessors:SlotsValuesMatrixBuilder",
        "slot_vocab": "#slot_vocab",
        "max_num_values": "#slot_filter.max_num_values",
        "in": ["prev_state", "slot_cand_indexer"],
        "out": ["prev_state_matr"]
      },
      {
        "class_name": "deeppavlov.models.state_tracker.preprocessors:SlotsActionsMatrixBuilder",
        "slot_vocab": "#slot_vocab",
        "action_vocab": "#user_action_vocab",
        "in": ["u_acts"],
        "out": ["u_slot_act_mask_matr"]
      },
      {
        "class_name": "deeppavlov.models.state_tracker.preprocessors:SlotsActionsMatrixBuilder",
        "slot_vocab": "#slot_vocab",
        "action_vocab": "#system_action_vocab",
        "in": ["s_acts"],
        "out": ["s_slot_act_mask_matr"]
      },
      {
        "class_name": "dst_network",
        "load_path": "{MODELS_PATH}/dst/model_phase1",
        "save_path": "{MODELS_PATH}/dst/model_phase1",
        "in": [
          "u_tok_idx", "u_tok_slot_idx_matr", "u_act_idx", "u_slot_act_mask_matr",
          "s_tok_idx", "s_tok_slot_idx_matr", "s_act_idx", "s_slot_act_mask_matr",
          "slot_cand_mask_matr", "prev_state_matr"
        ],
        "in_y": ["state_matr"],
        "out": ["state_pred_matr"],
        "hidden_size": 128,
        "dense_sizes": [128, 64],
        "num_slot_values": "#slot_filter.max_num_values",
        "embedding_matrix": "#embeddings.emb_mat",
        "num_user_actions": "#user_action_vocab.__len__()",
        "num_system_actions": "#system_action_vocab.__len__()",
        "learning_rate": [3e-2, 7e-4],
        "learning_rate_decay": "linear",
        "learning_rate_decay_epochs": 20,
        "optimizer": "tf.train:MomentumOptimizer",
        "momentum": 0.96
      },
      {
        "class_name": "deeppavlov.models.state_tracker.preprocessors:SlotsValuesMatrix2Dict",
        "slot_vocab": "#slot_vocab",
        "exclude_values": ["null"],
        "in": ["state_pred_matr", "slot_cand_indexer"],
        "out": ["state_pred"]
      }
    ]
  },
  "train": {
    "epochs": 21,
    "batch_size": 1,

    "metrics": ["accuracy"],
    "validation_patience": 10,
    "val_every_n_epochs": 1,

    "log_every_n_epochs": 1,
    "validate_best": true,
    "test_best": false,
    "tensorboard_log_dir": "{DOWNLOADS_PATH}/dp_logs_dst"
  },
  "metadata": {
    "variables": {
      "ROOT_PATH": "~/.deeppavlov",
      "DOWNLOADS_PATH": "{ROOT_PATH}/downloads",
      "MODELS_PATH": "{ROOT_PATH}/models",
      "CONFIGS_PATH": "{DEEPPAVLOV_PATH}/configs"
    },
    "requirements": [
      "{DEEPPAVLOV_PATH}/requirements/tf.txt",
      "{DEEPPAVLOV_PATH}/requirements/gensim.txt"
    ],
    "labels": {},
    "download": [
      {
        "url": "http://files.deeppavlov.ai/embeddings/glove.6B.100d.txt",
        "subdir": "{DOWNLOADS_PATH}/embeddings"
      }
    ]
  }
}
